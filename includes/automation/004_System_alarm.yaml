# -----------------------------------------------------------
# –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
# -----------------------------------------------------------

- alias: "004_System_CPU_Temperature_alarm"
  description: "–¢—Ä–µ–≤–æ–≥–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –¶–ü–£"
  trigger:
    platform: numeric_state
    entity_id: sensor.processor_temperature
    above: 50
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: '*–û–ü–û–í–ï–©–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´:*'
      message: >
        ‚ö†  –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞ {{ states('sensor.processor_temperature') }}
        
- alias: "004_System_CPU_usage_alarm"
  description: "–¢—Ä–µ–≤–æ–≥–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ —É—Ç–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"
  trigger:
    platform: numeric_state
    entity_id: sensor.processor_use
    above: 80
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: '*–û–ü–û–í–ï–©–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´:*'
      message: >
        ‚ö†  –¢—Ä–µ–≤–æ–≥–∞, –≤—ã—Å–æ–∫–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ {{ states('sensor.processor_use') }}
    
- alias: "004_System_Disk_usage_alarm"
  description: "–¢—Ä–µ–≤–æ–≥–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∏—Å–∫–∞"
  trigger:
    platform: numeric_state
    entity_id: sensor.disk_use_percent
    above: 60
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: '*–û–ü–û–í–ï–©–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´:*'
      message: >
        ‚ö†  –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –æ–±—ä—ë–º–∞ –¥–∏—Å–∫–∞ {{ states('sensor.disk_use_percent') }}
    
- alias: "004_System_Memory_usage_alarm"
  description: "–¢—Ä–µ–≤–æ–≥–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏"
  trigger:
    platform: numeric_state
    entity_id: sensor.memory_use_percent
    above: 70
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: '*–û–ü–û–í–ï–©–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´:*'
      message: >
        ‚ö†  –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º–æ–≥–æ –æ–±—ä—ë–º–∞ –ø–∞–º—è—Ç–∏ {{ states('sensor.date_time') }}
    
- alias: "004_Purge_Database"
  description: "–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
  initial_state: True
  trigger:
      platform: time
      at: '02:22:22'
  action:
      service: recorder.purge
      data:
        keep_days: 3
        repack: true

- alias: "004_Zigbee_Bridge_state_offline"
  description: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º"
  trigger:
  - entity_id: binary_sensor.zigbee2mqtt_bridge_connection_state
    from: online
    platform: state
    to: offline
  - entity_id: binary_sensor.zigbee2mqtt_bridge_connection_state_2
    from: online
    platform: state
    to: offline    
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: '*–û–ü–û–í–ï–©–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´:*'
      message: >
        ‚ö†  –ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å Zigbee –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º {{ states('sensor.date_time') }}
        
- alias: "004_Zigbee_Bridge_state_online"
  description: '–û—Ç–ø—Ä–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ —Å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º.'
  trigger:
  - entity_id: binary_sensor.zigbee2mqtt_bridge_connection_state
    from: offline
    platform: state
    to: online
  - entity_id: binary_sensor.zigbee2mqtt_bridge_connection_state_2
    from: offline
    platform: state
    to: online
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: '*–û–ü–û–í–ï–©–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´:*'
      message: >
        ‚ö†  C–≤—è–∑—å —Å Zigbee –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–æ–º  –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ {{ states('sensor.date_time') }}

- alias: "004_Zigbee_unhealthy_alert"
  description: '–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ z2m'
  trigger:
  - platform: state
    entity_id: binary_sensor.z2m_health
    to: 'on'
  - platform: time
    at: '08:00:00'
  - platform: time
    at: '20:00:00'
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      message: |-
        ‚ùå Zigbee last seen ‚ùåÔ∏è:  
        {{"*"}}{{state_attr('binary_sensor.z2m_health', 'data')}}{{"*: "}}
        
- alias: "004_Zigbee_Device_Missing_Alert"
  description: "–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö"
  trigger:
      - platform: time
        at: '07:00'
      - platform: time
        at: '16:00'
  condition:
      - condition: template
        value_template: |
          {% set ns = namespace(break = false) %} {% for state in states -%}
            {%- if state.attributes.last_seen %}
              {%- if (as_timestamp(now()) - as_timestamp(state.attributes.last_seen) > (60 * 60 * 20) ) and ns.break == false %}
                {%- set ns.break = true %}
                true
              {%- endif -%}
            {%- endif -%}
          {%- endfor %} 
  action:
      - service: telegram_bot.send_message
        data:
          message: >
            Some Zigbee devices haven't been seen lately... {% for state in states
            -%}
              {%- if (state.attributes.last_seen and not (state.name | regex_search('available|linkquality|power_on_behavior|state'))) %}
                {%- if (as_timestamp(now()) - as_timestamp(state.attributes.last_seen) > (60 * 60 * 20) ) %}
                  {{ ((as_timestamp(now()) - as_timestamp(state.attributes.last_seen)) / (3600)) | round(1) }} hours ago for {{"*"}}{{ state.name }}{{"*"}}
                  
                {%- endif -%}
              {%- endif -%}
            {%- endfor %}
  mode: single

- alias: "004_internet_ping_lost"
  description: "–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º"
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.internet_is_available
    from: 'on'
    to: 'off'
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: "*Problem with Internet!* ‚ö†Ô∏è"
      message: >
        ‚ö†  –ü–æ—Ç–µ—Ä—è–Ω–∞ —Å–≤—è–∑—å —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º {{ states('sensor.date_time') }}
        
- alias: "004_internet_ping_available"
  description: "–û–ø–æ–≤–µ—â–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç—Ä–µ–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è"
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.internet_is_available
    from: 'off'
    to: 'on'
  condition:
  - condition: state
    entity_id: input_boolean.control_mode
    state: 'on'
  action:
  - data: {}
    service: telegram_bot.send_message
    data_template:
      title: "*Problem with Internet!* ‚ö†Ô∏è"
      message: >
        üëç  C–≤—è–∑—å —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ {{ states('sensor.date_time') }}