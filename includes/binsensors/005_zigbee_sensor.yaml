# Сенсор состояния Z2M
template:
- binary_sensor:
  - default_entity_id: binary_sensor.z2m_health
    attributes:
      data: "{%- macro GetDroppedZigbee() -%} {% for state in states.sensor -%}\n
        \ {%- if (\"linkquality\" in state.name and state_attr(state.entity_id, \"last_seen\")
        != None and (as_timestamp(now()) - as_timestamp(state_attr(state.entity_id,
        \"last_seen\")) > (24 * 60 * 60))) -%}\n  {{ state.name | regex_replace(find='
        linkquality', replace='', ignorecase=False) }} - {{ relative_time(strptime(state_attr(state.entity_id,
        \"last_seen\"), '%Y-%m-%dT%H:%M:%S%z')) }} ago {{- '\\n' -}}\n  {%- endif
        -%}\n{%- endfor %} {%- endmacro -%} {{ GetDroppedZigbee() }}"
    name: Z2M Mesh health
    state: "{%- macro CheckDroppedZigbee() -%} {% for state in states.sensor -%}\n
      \ {%- if (\"linkquality\" in state.name and state_attr(state.entity_id, \"last_seen\")
      != None and (as_timestamp(now()) - as_timestamp(state_attr(state.entity_id,
      \"last_seen\")) > (24 * 60 * 60))) -%}\n  {{ state.name }}\n  {%- endif -%}\n{%-
      endfor %} {%- endmacro -%} {% set output = CheckDroppedZigbee() %} {% if output
      | trim == \"\" %} false {%- else -%} true {%- endif -%}"